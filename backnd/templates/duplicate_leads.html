{% load static %}
{% block body %}
    <section class='lead-list'>
        <form action="{% url 'excel_file_lead_upload_duplicate_accept' %}" id="duplicates" method="post">
            {% csrf_token %}

            <button class='btn btn-outline-success m-2'>Duplicate Leads <b>{{ length }}</b></button>
            
            <input type="text" name="duplicates_leads" value="{{ data }}" style="visibility: hidden">
            
            <input type='submit' class='btn btn-info' value="Accept">
            <a type='button' href="{% url 'lead_list' %}" class='btn btn-outline-primary mx-2' id="discard">Discard</a>

            <div class="table-div p-3 shadow">
                <table class="table sortable" id="data-table">
                    <thead class="thead-dark">
                    <tr>
                        <th scope="col">No.</th>
                        <th scope="col">Owner Name</th>
                        <th scope="col">Contact No</th>
                        <th scope="col">Email ID</th>
                        <th scope="col">Job Role</th>
                        <th scope="col">Type</th>
                        <th scope="col">Lead-in Date</th>
                        <th scope="col">Requirement Start Time</th>
                        <th scope="col">Requirement End Time</th>
                        <th scope="col">Society</th>
                        <th scope="col">Flat No</th>
                        <th scope="col">Helper Requirement Form Fill Status</th>
                        <th scope="col">Lead Status</th>
                        <th scope="col">Helper Name</th>
                        <th scope="col">Actual Status</th>
                        <th scope="col">Lead Lost Reason</th>
                        <th scope="col">Date of Placement</th>
                        <th scope="col">Date of Exit</th>
                        <th scope="col">ID Proof Type</th>
                        <th scope="col">ID Proof Status</th>
                        <th scope="col">ID proof shared with Customer</th>
                        <th scope="col">Employer Application Form</th>
                        <th scope="col">Total Duration</th>
                        <th scope="col">Payment Date</th>
                        <th scope="col">Payment Status</th>
                        <th scope="col">Payment Mode</th>
                        <th scope="col">Receivables / Salary</th>
                        <th scope="col">Paid - 3rd Party</th>
                        <th scope="col">Ezy Commission</th>
                        <th scope="col">Lead Source</th>
                        <th scope="col">Sales Person</th>
                        <th scope="col">Comments</th>
                        <th scope="col">Remarks</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for i in data %}

                        <tr id="itemList">
                            <th scope="row">{{ forloop.counter }}</th>
                            <td>{{ i.name }}</td>
                            <td>{{ i.phone }}</td>
                            <td>{{ i.email_id }}</td>
                            <td>{{ i.availability_status }}</td>
                            <td>{{ i.job_category }}</td>
                            <td>{{ i.lead_in_date }}</td>
                            <td>{{ i.requirement_start_time }}</td>
                            <td>{{ i.requirement_end_time }}</td>
                            <td>{{ i.society }}</td>
                            <td>{{ i.flat_number }}</td>
                            <td>{{ i.form_fill_status }}</td>
                            <td>{{ i.lead_status }}</td>
                            <td>{{ i.helper_name }}</td>
                            <td>{{ i.actual_status }}</td>
                            <td>{{ i.lead_lost_reason }}</td>
                            <td>{{ i.lead_placement_date }}</td>
                            <td>{{ i.exit_date }}</td>
                            <td>{{ i.identity_type }}</td>
                            <td>{{ i.identity_status }}</td>
                            <td>{{ i.identity_shared }}</td>
                            <td>{{ i.application_form }}</td>
                            <td>{{ i.duration }}</td>
                            <td>{{ i.payment_date }}</td>
                            <td>{{ i.payment_status }}</td>
                            <td>{{ i.payment_mode }}</td>
                            <td>{{ i.salary }}</td>
                            <td>{{ i.third_party }}</td>
                            <td>{{ i.commission }}</td>
                            <td>{{ i.lead_source }}</td>
                            <td>{{ i.sales_person }}</td>
                            <td>{{ i.additional_comment }}</td>
                            <td>{{ i.remarks }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </section>

    <script>

        document.addEventListener('click', function (e) {
            try {
                // allows for elements inside TH
                function findElementRecursive(element, tag) {
                    return element.nodeName === tag ? element : findElementRecursive(element.parentNode, tag)
                }

                var descending_th_class = ' dir-d '
                var ascending_th_class = ' dir-u '
                var ascending_table_sort_class = 'asc'
                var regex_dir = / dir-(u|d) /
                var regex_table = /\bsortable\b/
                var alt_sort = e.shiftKey || e.altKey
                var element = findElementRecursive(e.target, 'TH')
                var tr = findElementRecursive(element, 'TR')
                var table = findElementRecursive(tr, 'TABLE')

                function reClassify(element, dir) {
                    element.className = element.className.replace(regex_dir, '') + dir
                }

                function getValue(element) {
                    // If you aren't using data-sort and want to make it just the tiniest bit smaller/faster
                    // comment this line and uncomment the next one
                    var value =
                        (alt_sort && element.getAttribute('data-sort-alt')) || element.getAttribute('data-sort') || element.innerText
                    return value
                    // return element.innerText
                }

                if (regex_table.test(table.className)) {
                    var column_index
                    var nodes = tr.cells

                    // Reset thead cells and get column index
                    for (var i = 0; i < nodes.length; i++) {
                        if (nodes[i] === element) {
                            column_index = element.getAttribute('data-sort-col') || i
                        } else {
                            reClassify(nodes[i], '')
                        }
                    }

                    var dir = descending_th_class

                    // Check if we're sorting ascending or descending
                    if (
                        element.className.indexOf(descending_th_class) !== -1 ||
                        (table.className.indexOf(ascending_table_sort_class) !== -1 &&
                            element.className.indexOf(ascending_th_class) == -1)
                    ) {
                        dir = ascending_th_class
                    }

                    // Update the `th` class accordingly
                    reClassify(element, dir)

                    // loop through all tbodies and sort them
                    for (var i = 0; i < table.tBodies.length; i++) {
                        const org_tbody = table.tBodies[i]

                        // Get the array rows in an array, so we can sort them...
                        var rows = [].slice.call(org_tbody.rows, 0)

                        var reverse = dir === ascending_th_class

                        // Sort them using Array.prototype.sort()
                        rows.sort(function (a, b) {
                            var x = getValue((reverse ? a : b).cells[column_index])
                            var y = getValue((reverse ? b : a).cells[column_index])
                            var bool = x.length && y.length && !isNaN(x - y) ? x - y : x.localeCompare(y)
                            return bool
                        })

                        // Make a clone without content
                        var clone_tbody = org_tbody.cloneNode()

                        // Fill it with the sorted values
                        while (rows.length) {
                            clone_tbody.appendChild(rows.splice(0, 1)[0])
                        }

                        // And finally replace the unsorted table with the sorted one
                        table.replaceChild(clone_tbody, org_tbody)
                    }
                }
            } catch (error) {
                // console.log(error)
            }
        })
    </script>
{% endblock body %}